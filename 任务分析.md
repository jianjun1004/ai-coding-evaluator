# Context
Filename: 任务分析.md
Created On: 2025-01-27
Created By: CodeCraft
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
修复第三步配置页面中"立即执行"功能没有与后端API交互的问题。目前该功能使用的是模拟API调用，需要改为真实的API调用。同时需要解决数据结构不匹配、TypeScript类型错误、执行流程设计问题以及问题内容丢失等问题。

# Project Overview
这是一个AI编程产品评测工作流系统，包含前端React应用和后端Node.js/Express API。前端通过三步配置流程来设置评测任务，第三步包含"保存任务"和"立即执行"两个功能按钮。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
通过代码分析发现以下问题：

1. **前端问题**：`Step3Config.jsx`中的`handleExecute`函数（立即执行）使用了模拟API调用：
   ```javascript
   // 模拟API调用执行任务
   await new Promise(resolve => setTimeout(resolve, 2000))
   ```

2. **对比分析**：`handleSave`函数（保存任务）正确调用了后端API：
   ```javascript
   const response = await fetch('/api/tasks/execute', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify(taskData)
   })
   ```

3. **后端支持**：后端已经实现了`/api/tasks/execute`端点，可以处理任务执行请求。

4. **技术栈**：前端使用React + Vite，后端使用Express + TypeScript，通过Vite代理配置`/api`路径到`http://localhost:3000`。

5. **问题根源**：前端开发时可能为了快速测试而使用了模拟调用，但忘记替换为真实API调用。

**新发现的关键问题**：
6. **数据结构不匹配**：前端发送的数据结构与后端期望的不一致：
   - 前端发送：`aiProductIds`（ID数组）和`questionTypes`（类型数组）
   - 后端期望：`aiProducts`（AIProduct对象数组）和`questionTypes`（类型数组）
   
7. **运行时错误**：在`TaskSchedulerService.calculateTotalSteps()`方法中，代码试图访问`task.aiProducts.length`，但`aiProducts`是`undefined`，导致`Cannot read properties of undefined (reading 'length')`错误。

**新发现的问题**：
8. **执行流程设计问题**：前端点击"立即执行"后立即收到响应，但没有评测结果：
   - 当前实现：后端立即返回"任务已开始执行"，然后异步执行评测任务
   - 前端期望：希望看到评测结果或至少看到执行进度
   - 问题根源：缺少前端获取评测结果或进度的机制

9. **问题内容丢失问题**：执行任务时AI产品中发送的内容并不是第二步中填写或生成的问题：
   - 当前实现：后端只接收`questionTypes`（问题类型），然后重新生成问题
   - 用户期望：使用第二步中已经填写或生成的具体问题内容
   - 问题根源：任务数据结构中缺少具体问题内容字段，后端执行时重新生成问题而不是使用用户提供的问题

# Proposed Solution (Populated by INNOVATE mode)
推荐采用功能差异化设计方案，并修复数据结构不匹配问题：

**方案二：功能差异化设计**
- `handleSave`：保存任务配置到后端，但不立即执行
- `handleExecute`：保存配置并立即开始执行任务

**优势分析**：
1. **功能清晰**：两个按钮有明确的职责分工
2. **用户体验**：用户可以保存配置后稍后执行，也可以直接执行
3. **代码结构**：避免功能重复，保持代码的清晰性
4. **扩展性**：为未来功能扩展留下空间

**技术实现**：
- 修改`handleExecute`函数，使其调用真实的API端点
- 保持`handleSave`的现有功能
- 确保两个函数都能正确处理错误和成功状态

**新发现问题的解决方案**：
- **数据结构转换**：在后端`executeTask`方法中，将前端发送的`aiProductIds`转换为完整的`aiProducts`对象数组
- **数据验证**：确保所有必需字段都存在且格式正确
- **错误处理**：提供清晰的错误信息，帮助调试数据问题

**执行流程问题解决方案**：
- **异步执行 + 进度查询模式**：保持后端异步执行评测任务，增强前端进度查询功能
- **实时状态更新**：前端可以查询任务执行状态、进度和结果
- **用户反馈优化**：提供清晰的任务执行状态信息，让用户了解当前进度

**问题内容丢失问题解决方案**：
- **扩展任务数据结构**：在EvaluationTask接口中添加questions字段，包含第二步中用户填写或生成的具体问题内容
- **修改执行逻辑**：TaskSchedulerService使用用户提供的问题内容而不是重新生成
- **保持向后兼容**：如果没有传递具体问题，则使用默认的问题生成逻辑

# Implementation Plan (Generated by PLAN mode)
**实施计划概述**：
需要解决四个问题：
1. 修复前端立即执行功能没有与后端交互的问题
2. 修复数据结构不匹配导致后端执行失败的问题
3. 修复执行流程设计问题 - 前端无法获取评测结果
4. 修复问题内容丢失问题 - 执行时没有使用第二步的具体问题内容

**详细变更计划**：

**[变更计划1]**
- 文件：`frontend/src/components/task-steps/Step3Config.jsx`
- 理由：修复立即执行功能没有与后端交互的问题，实现真实的API调用

**[变更计划2]**
- 文件：`backend/src/controllers/task.controller.ts`
- 理由：修复数据结构不匹配问题，将前端发送的ID数组转换为后端期望的对象数组

**[变更计划3]**
- 文件：`backend/src/models/index.ts`
- 理由：扩展EvaluationTask接口，添加questions字段以支持用户提供的具体问题内容

**[变更计划4]**
- 文件：`backend/src/controllers/task.controller.ts`
- 理由：修改executeTask方法，接收和处理前端传递的具体问题内容

**[变更计划5]**
- 文件：`backend/src/services/task-scheduler.service.ts`
- 理由：修改执行逻辑，优先使用用户提供的问题内容，如果没有则使用默认生成

**实施检查清单**：

```
Implementation Checklist:
1. 修改handleExecute函数，替换模拟API调用为真实fetch请求
2. 使用正确的API端点'/api/tasks/execute'
3. 添加适当的错误处理逻辑
4. 确保loading状态正确管理
5. 验证成功和失败的用户反馈
6. 测试修改后的功能是否正常工作
7. 修复后端数据结构转换问题
8. 验证修复后的完整流程
9. 修复TypeScript类型错误
10. 增强前端进度查询功能
11. 实现任务状态实时更新
12. 测试完整的执行流程
13. 扩展任务数据结构，添加questions字段
14. 修改后端控制器，接收具体问题内容
15. 修改任务调度服务，使用用户提供的问题
16. 测试问题内容传递的完整流程
```

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> 当前执行：步骤 1 - 修改handleExecute函数，替换模拟API调用为真实fetch请求

# Task Progress (Appended by EXECUTE mode after each step completion)
[2025-01-27]
- Step: 1. 修改handleExecute函数，替换模拟API调用为真实fetch请求
- Modifications: 将Step3Config.jsx中handleExecute函数的模拟API调用替换为真实的fetch请求到'/api/tasks/execute'端点，并添加了startProgressQuery函数实现进度查询功能
- Change Summary: 修复了立即执行功能没有与后端交互的问题，现在该功能会调用真实的API端点，并具有完整的进度查询和异常检测功能
- Reason: 执行计划步骤1
- Blockers: 无
- Status: 成功

[2025-01-27]
- Step: 13. 扩展任务数据结构，添加questions字段
- Modifications: 在models/index.ts的EvaluationTask接口中添加了questions字段，用于存储用户提供或生成的具体问题内容
- Change Summary: 现在任务数据结构支持存储具体问题内容，为解决问题内容丢失问题奠定了基础
- Reason: 执行计划步骤13
- Blockers: 无
- Status: 成功

[2025-01-27]
- Step: 14. 修改后端控制器，接收具体问题内容
- Modifications: 在task.controller.ts的executeTask方法中添加了问题内容验证逻辑，并在任务对象中包含questions字段
- Change Summary: 现在后端可以接收和验证用户提供的具体问题内容，确保数据完整性
- Reason: 执行计划步骤14
- Blockers: 无
- Status: 成功

[2025-01-27]
- Step: 15. 修改任务调度服务，使用用户提供的问题
- Modifications: 在task-scheduler.service.ts的processQuestionType方法中添加了问题内容优先级逻辑，优先使用用户提供的问题，如果没有则使用默认生成
- Change Summary: 现在任务调度服务会优先使用第二步中用户填写或生成的具体问题内容，而不是重新生成问题
- Reason: 执行计划步骤15
- Blockers: 无
- Status: 成功

[2025-01-27]
- Step: 16. 测试问题内容传递的完整流程
- Modifications: 验证了所有修复步骤的完整性，包括数据结构扩展、控制器修改和任务调度服务优化
- Change Summary: 现在整个系统支持从第二步传递具体问题内容到第三步执行，解决了问题内容丢失的核心问题
- Reason: 执行计划步骤16
- Blockers: 无
- Status: 待确认

# Final Review (Populated by REVIEW mode)
[待填充]
