# AI编程产品评测工作流系统 - 部署文档

**版本**: 1.0.0  
**作者**: Manus AI  
**更新日期**: 2025年8月6日

## 目录

1. [部署概述](#部署概述)
2. [环境准备](#环境准备)
3. [本地开发部署](#本地开发部署)
4. [生产环境部署](#生产环境部署)
5. [Docker部署](#docker部署)
6. [云平台部署](#云平台部署)
7. [监控与维护](#监控与维护)
8. [故障排除](#故障排除)

## 部署概述

AI编程产品评测工作流系统采用前后端分离的架构设计，支持多种部署方式。系统主要包含以下组件：

- **前端应用**: React + TypeScript + Vite构建的单页应用
- **后端服务**: Node.js + Express + TypeScript构建的API服务
- **数据存储**: SQLite本地数据库 + 飞书多维表格
- **浏览器引擎**: Puppeteer驱动的Chrome浏览器
- **文件存储**: 本地文件系统（日志、截图等）

系统设计为轻量级部署，最小化外部依赖，可以在单台服务器上完整运行，也支持分布式部署以提高性能和可靠性。

## 环境准备

### 系统要求

**最低配置**:
- CPU: 2核心
- 内存: 4GB RAM
- 存储: 20GB可用空间
- 操作系统: Ubuntu 20.04+ / CentOS 8+ / macOS 10.15+ / Windows 10+

**推荐配置**:
- CPU: 4核心或更多
- 内存: 8GB RAM或更多
- 存储: 50GB SSD
- 网络: 稳定的互联网连接（带宽≥10Mbps）

### 软件依赖

**Node.js环境**:
```bash
# 安装Node.js 18.x LTS版本
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version  # 应显示v18.x.x
npm --version   # 应显示9.x.x或更高
```

**系统依赖包**:
```bash
# Ubuntu/Debian系统
sudo apt-get update
sudo apt-get install -y \
    wget \
    gnupg \
    ca-certificates \
    fonts-liberation \
    libappindicator3-1 \
    libasound2 \
    libatk-bridge2.0-0 \
    libdrm2 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libxss1 \
    libxtst6 \
    xdg-utils

# CentOS/RHEL系统
sudo yum install -y \
    wget \
    gnupg \
    ca-certificates \
    liberation-fonts \
    libappindicator-gtk3 \
    alsa-lib \
    at-spi2-atk \
    libdrm \
    gtk3 \
    nspr \
    nss \
    libXScrnSaver \
    libXtst \
    xdg-utils
```

**Chrome/Chromium浏览器**:
```bash
# 安装Google Chrome
wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
sudo apt-get update
sudo apt-get install -y google-chrome-stable

# 或者安装Chromium
sudo apt-get install -y chromium-browser
```

## 本地开发部署

本地开发部署适用于开发测试和小规模使用场景。

### 快速启动

1. **获取源代码**
```bash
git clone <repository-url>
cd ai-coding-evaluator
```

2. **安装依赖**
```bash
# 安装后端依赖
cd backend
npm install

# 安装前端依赖
cd ../frontend
npm install
```

3. **环境配置**
```bash
# 复制环境变量模板
cd ../backend
cp .env.example .env

# 编辑环境变量
nano .env
```

环境变量配置示例：
```env
# 服务配置
NODE_ENV=development
PORT=3001
HOST=0.0.0.0

# 数据库配置
DATABASE_PATH=./data/database.sqlite

# 飞书配置
FEISHU_APP_ID=your_app_id
FEISHU_APP_SECRET=your_app_secret
FEISHU_TABLE_ID=your_table_id

# 浏览器配置
BROWSER_HEADLESS=true
BROWSER_TIMEOUT=30000
ENABLE_SCREENSHOTS=true

# 日志配置
LOG_LEVEL=info
LOG_DIR=./logs
```

4. **初始化数据库**
```bash
cd backend
npm run db:init
```

5. **构建项目**
```bash
# 构建后端
npm run build

# 构建前端
cd ../frontend
npm run build
```

6. **启动服务**
```bash
# 启动后端服务
cd ../backend
npm start

# 启动前端服务（开发模式）
cd ../frontend
npm run dev
```

7. **访问系统**
- 前端界面: http://localhost:5173
- 后端API: http://localhost:3001
- 健康检查: http://localhost:3001/health

### 开发模式

开发模式支持热重载和实时调试：

```bash
# 后端开发模式
cd backend
npm run dev

# 前端开发模式
cd frontend
npm run dev
```

## 生产环境部署

生产环境部署需要考虑性能、安全性和稳定性。

### 服务器准备

1. **创建专用用户**
```bash
# 创建应用用户
sudo useradd -m -s /bin/bash aieval
sudo usermod -aG sudo aieval

# 切换到应用用户
sudo su - aieval
```

2. **创建目录结构**
```bash
mkdir -p ~/ai-coding-evaluator/{app,data,logs,backups}
cd ~/ai-coding-evaluator
```

3. **部署应用代码**
```bash
# 上传代码到服务器
scp -r ./ai-coding-evaluator aieval@your-server:~/

# 或使用git克隆
git clone <repository-url> app
cd app
```

### 生产环境配置

1. **环境变量配置**
```bash
cd ~/ai-coding-evaluator/app/backend
cp .env.example .env.production

# 编辑生产环境配置
nano .env.production
```

生产环境配置示例：
```env
NODE_ENV=production
PORT=3001
HOST=0.0.0.0

# 数据库配置
DATABASE_PATH=/home/aieval/ai-coding-evaluator/data/database.sqlite

# 飞书配置
FEISHU_APP_ID=cli_xxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxx
FEISHU_TABLE_ID=xxxxxxxxxx

# 浏览器配置
BROWSER_HEADLESS=true
BROWSER_TIMEOUT=45000
ENABLE_SCREENSHOTS=true
SCREENSHOT_DIR=/home/aieval/ai-coding-evaluator/data/screenshots

# 日志配置
LOG_LEVEL=info
LOG_DIR=/home/aieval/ai-coding-evaluator/logs

# 安全配置
SESSION_SECRET=your-very-secure-random-string
JWT_SECRET=your-jwt-secret-key

# 性能配置
MAX_CONCURRENT_TASKS=3
REQUEST_TIMEOUT=60000
```

2. **安装依赖和构建**
```bash
# 安装生产依赖
cd backend
npm ci --only=production

cd ../frontend
npm ci --only=production

# 构建应用
cd ../backend
npm run build

cd ../frontend
npm run build
```

3. **数据库初始化**
```bash
cd ~/ai-coding-evaluator/app/backend
NODE_ENV=production npm run db:init
```

### 进程管理

使用PM2进行进程管理，确保服务的稳定运行：

1. **安装PM2**
```bash
npm install -g pm2
```

2. **创建PM2配置文件**
```bash
cd ~/ai-coding-evaluator/app
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [
    {
      name: 'ai-evaluator-backend',
      script: './backend/dist/app.js',
      cwd: './backend',
      env: {
        NODE_ENV: 'production',
        PORT: 3001
      },
      instances: 1,
      exec_mode: 'fork',
      max_memory_restart: '1G',
      error_file: '../logs/backend-error.log',
      out_file: '../logs/backend-out.log',
      log_file: '../logs/backend-combined.log',
      time: true,
      autorestart: true,
      watch: false,
      max_restarts: 10,
      min_uptime: '10s'
    }
  ]
};
EOF
```

3. **启动服务**
```bash
# 启动应用
pm2 start ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs

# 设置开机自启
pm2 startup
pm2 save
```

### 反向代理配置

使用Nginx作为反向代理，提供静态文件服务和负载均衡：

1. **安装Nginx**
```bash
sudo apt-get install -y nginx
```

2. **创建Nginx配置**
```bash
sudo nano /etc/nginx/sites-available/ai-evaluator
```

配置内容：
```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /home/aieval/ai-coding-evaluator/app/frontend/dist;
        try_files $uri $uri/ /index.html;
        
        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # API代理
    location /api/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # 健康检查
    location /health {
        proxy_pass http://localhost:3001;
        access_log off;
    }

    # 日志配置
    access_log /var/log/nginx/ai-evaluator-access.log;
    error_log /var/log/nginx/ai-evaluator-error.log;
}
```

3. **启用配置**
```bash
sudo ln -s /etc/nginx/sites-available/ai-evaluator /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### SSL证书配置

使用Let's Encrypt免费SSL证书：

```bash
# 安装Certbot
sudo apt-get install -y certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行：
# 0 12 * * * /usr/bin/certbot renew --quiet
```

## Docker部署

Docker部署提供了更好的环境隔离和部署一致性。

### Dockerfile配置

1. **后端Dockerfile**
```dockerfile
# backend/Dockerfile
FROM node:18-alpine

# 安装Chrome依赖
RUN apk add --no-cache \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont

# 设置Chrome路径
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
    PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

# 创建应用目录
WORKDIR /app

# 复制package文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制源代码
COPY . .

# 构建应用
RUN npm run build

# 创建非root用户
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

# 设置权限
RUN chown -R nodejs:nodejs /app
USER nodejs

# 暴露端口
EXPOSE 3001

# 启动命令
CMD ["npm", "start"]
```

2. **前端Dockerfile**
```dockerfile
# frontend/Dockerfile
FROM node:18-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

3. **Docker Compose配置**
```yaml
# docker-compose.yml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - DATABASE_PATH=/app/data/database.sqlite
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend
    restart: unless-stopped

volumes:
  data:
  logs:
```

### 部署命令

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 云平台部署

### AWS部署

1. **EC2实例配置**
- 实例类型: t3.medium或更高
- 操作系统: Ubuntu 20.04 LTS
- 存储: 30GB gp3 SSD
- 安全组: 开放80、443、22端口

2. **RDS数据库**（可选）
如果需要更高的数据可靠性，可以使用RDS PostgreSQL替代SQLite：

```bash
# 安装PostgreSQL客户端
sudo apt-get install -y postgresql-client

# 修改环境变量
DATABASE_URL=postgresql://username:password@rds-endpoint:5432/dbname
```

3. **S3存储**（可选）
用于存储截图和日志文件：

```javascript
// 配置AWS SDK
const AWS = require('aws-sdk');
const s3 = new AWS.S3({
  accessKeyId: process.env.AWS_ACCESS_KEY_ID,
  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
  region: process.env.AWS_REGION
});
```

### 阿里云部署

1. **ECS实例配置**
- 实例规格: ecs.t6-c2m4.large或更高
- 镜像: Ubuntu 20.04
- 系统盘: 40GB ESSD
- 安全组: 开放80、443端口

2. **负载均衡配置**
```bash
# 安装阿里云CLI
wget https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
tar xzvf aliyun-cli-linux-latest-amd64.tgz
sudo mv aliyun /usr/local/bin/

# 配置负载均衡
aliyun slb CreateLoadBalancer --RegionId cn-hangzhou
```

### 腾讯云部署

1. **CVM实例配置**
- 机型: S5.MEDIUM4或更高
- 镜像: Ubuntu Server 20.04 LTS
- 系统盘: 50GB SSD云硬盘

2. **CDN配置**
```bash
# 配置腾讯云CDN加速静态资源
# 在腾讯云控制台配置CDN域名和回源设置
```

## 监控与维护

### 系统监控

1. **性能监控**
```bash
# 安装监控工具
npm install -g clinic

# 性能分析
clinic doctor -- node dist/app.js
clinic bubbleprof -- node dist/app.js
```

2. **日志监控**
```bash
# 使用ELK Stack进行日志分析
# 安装Elasticsearch、Logstash、Kibana

# 配置Logstash
input {
  file {
    path => "/home/aieval/ai-coding-evaluator/logs/*.log"
    start_position => "beginning"
  }
}

filter {
  json {
    source => "message"
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "ai-evaluator-%{+YYYY.MM.dd}"
  }
}
```

3. **健康检查**
```bash
# 创建健康检查脚本
cat > ~/health-check.sh << 'EOF'
#!/bin/bash

# 检查后端服务
if curl -f http://localhost:3001/health > /dev/null 2>&1; then
    echo "Backend: OK"
else
    echo "Backend: FAILED"
    # 重启服务
    pm2 restart ai-evaluator-backend
fi

# 检查磁盘空间
DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "Disk usage high: ${DISK_USAGE}%"
    # 清理日志文件
    find ~/ai-coding-evaluator/logs -name "*.log" -mtime +7 -delete
fi

# 检查内存使用
MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.2f", $3/$2 * 100.0)}')
if (( $(echo "$MEMORY_USAGE > 90" | bc -l) )); then
    echo "Memory usage high: ${MEMORY_USAGE}%"
fi
EOF

chmod +x ~/health-check.sh

# 设置定时任务
crontab -e
# 添加：*/5 * * * * /home/aieval/health-check.sh >> /home/aieval/health-check.log 2>&1
```

### 备份策略

1. **数据库备份**
```bash
# 创建备份脚本
cat > ~/backup.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="/home/aieval/ai-coding-evaluator/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份数据库
cp /home/aieval/ai-coding-evaluator/data/database.sqlite \
   $BACKUP_DIR/database_$DATE.sqlite

# 备份配置文件
tar -czf $BACKUP_DIR/config_$DATE.tar.gz \
    /home/aieval/ai-coding-evaluator/app/backend/.env.production

# 清理旧备份（保留30天）
find $BACKUP_DIR -name "*.sqlite" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "Backup completed: $DATE"
EOF

chmod +x ~/backup.sh

# 设置每日备份
crontab -e
# 添加：0 2 * * * /home/aieval/backup.sh >> /home/aieval/backup.log 2>&1
```

2. **远程备份**
```bash
# 配置AWS S3备份
aws s3 sync /home/aieval/ai-coding-evaluator/backups \
    s3://your-backup-bucket/ai-evaluator-backups/

# 或使用rsync到远程服务器
rsync -avz /home/aieval/ai-coding-evaluator/backups/ \
    user@backup-server:/path/to/backups/
```

### 更新维护

1. **应用更新**
```bash
# 创建更新脚本
cat > ~/update.sh << 'EOF'
#!/bin/bash

cd /home/aieval/ai-coding-evaluator/app

# 备份当前版本
cp -r . ../backup_$(date +%Y%m%d_%H%M%S)

# 拉取最新代码
git pull origin main

# 安装依赖
cd backend && npm ci --only=production
cd ../frontend && npm ci --only=production

# 构建应用
cd ../backend && npm run build
cd ../frontend && npm run build

# 重启服务
pm2 restart ai-evaluator-backend

echo "Update completed"
EOF

chmod +x ~/update.sh
```

2. **系统更新**
```bash
# 定期系统更新
sudo apt-get update && sudo apt-get upgrade -y
sudo apt-get autoremove -y
sudo apt-get autoclean
```

## 故障排除

### 常见问题

1. **服务启动失败**
```bash
# 检查端口占用
sudo netstat -tlnp | grep :3001

# 检查进程状态
pm2 status
pm2 logs ai-evaluator-backend

# 检查系统资源
free -h
df -h
```

2. **浏览器自动化失败**
```bash
# 检查Chrome安装
google-chrome --version
chromium-browser --version

# 检查依赖包
ldd $(which google-chrome) | grep "not found"

# 手动测试Puppeteer
node -e "
const puppeteer = require('puppeteer');
(async () => {
  const browser = await puppeteer.launch();
  console.log('Puppeteer works!');
  await browser.close();
})();
"
```

3. **数据库问题**
```bash
# 检查数据库文件权限
ls -la /home/aieval/ai-coding-evaluator/data/

# 检查数据库完整性
sqlite3 database.sqlite "PRAGMA integrity_check;"

# 修复数据库
sqlite3 database.sqlite "VACUUM;"
```

4. **网络连接问题**
```bash
# 测试AI产品网站连通性
curl -I https://www.doubao.com/chat/
curl -I https://www.kimi.com/
curl -I https://chat.qwen.ai/

# 检查DNS解析
nslookup www.doubao.com
dig www.kimi.com
```

### 性能优化

1. **系统调优**
```bash
# 增加文件描述符限制
echo "* soft nofile 65536" | sudo tee -a /etc/security/limits.conf
echo "* hard nofile 65536" | sudo tee -a /etc/security/limits.conf

# 优化内核参数
echo "net.core.somaxconn = 65535" | sudo tee -a /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 65535" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

2. **应用优化**
```bash
# 启用Node.js集群模式
# 修改ecosystem.config.js
instances: 'max',
exec_mode: 'cluster'

# 启用HTTP/2
# 在Nginx配置中添加
listen 443 ssl http2;
```

### 安全加固

1. **系统安全**
```bash
# 配置防火墙
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443

# 禁用root登录
sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sudo systemctl restart ssh

# 安装fail2ban
sudo apt-get install -y fail2ban
```

2. **应用安全**
```bash
# 设置环境变量权限
chmod 600 .env.production

# 配置HTTPS重定向
# 在Nginx配置中添加
if ($scheme != "https") {
    return 301 https://$host$request_uri;
}
```

---

*本部署文档涵盖了主要的部署场景和配置方法。如遇到特殊问题，请参考相关组件的官方文档或联系技术支持。*

